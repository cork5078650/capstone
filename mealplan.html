
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meal Plan - Smart Nutrition Planner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-[var(--cream)] text-[var(--teal)] font-sans">

  <header class="bg-[var(--teal)] fixed w-full top-0 z-50 shadow-md">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-white">Smart Nutrition Planner</h1>
      <nav class="flex items-center space-x-4">
          <a href="dashboard.html" class="text-white font-medium hover:text-[var(--sage)] transition-colors">Dashboard</a>
          <a href="mealplan.html" class="text-white font-medium hover:text-[var(--sage)] transition-colors">Meal Plan</a>
          <a href="recipes.html" class="text-white font-medium hover:text-[var(--sage)] transition-colors">Recipes</a>
          <button id="logoutBtn" class="bg-[var(--peach)] px-4 py-2 rounded-lg text-white font-semibold hover:bg-opacity-90">
              Logout
          </button>
      </nav>
    </div>
  </header>

  <div class="min-h-screen pt-28 pb-12 flex flex-col items-center">
    <h2 class="text-3xl font-bold mb-8 text-[var(--teal)]">Your Personalized Meal Plan</h2>
    
    <div class="w-full max-w-4xl bg-[var(--sage)] p-8 rounded-xl shadow-lg space-y-6">
      <div id="mealPlanSummary" class="bg-[var(--beige)] p-6 rounded-lg shadow-inner">
        </div>
      <div id="mealPlanContainer" class="space-y-4">
        </div>
      
      <button id="generateBtn" class="w-full bg-[var(--peach)] text-white py-2 rounded-lg font-semibold hover:bg-opacity-90">
        Generate New Meal Plan
      </button>
    </div>
  </div>

  <footer class="bg-[var(--teal)] text-white py-6 mt-12">
    <div class="max-w-7xl mx-auto px-6 text-center">
      <p>&copy; 2025 Smart Nutrition Planner</p>
    </div>
  </footer>

  <script src="recipes-data.js"></script>
  <script>
    function calculateBMR(profile) {
      const { gender, age, height, weight, activity, goal } = profile;
      let bmr = 0;
      if (gender === 'Male') {
        bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
      } else {
        bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
      }
      
      const activityMultipliers = {
        'Sedentary': 1.2,
        'Lightly Active': 1.375,
        'Moderately Active': 1.55,
        'Very Active': 1.725
      };
      const tdee = bmr * activityMultipliers[activity];

      let finalCalories = tdee;
      if (goal === 'Lose Weight') {
        finalCalories -= 500;
      } else if (goal === 'Gain Weight') {
        finalCalories += 500;
      }
      return finalCalories;
    }

    function calculateProteinTarget(profile) {
      const { weight, goal } = profile;
      let proteinPerKg = 0.8;
      if (profile.activity === 'Moderately Active' || profile.activity === 'Very Active' || goal === 'Gain Weight') {
          proteinPerKg = 1.6;
      }
      return Math.round(weight * proteinPerKg);
    }

    function findClosestCalorieCategory(mealType, targetCalories) {
        const categories = Object.keys(recipeDatabase[mealType]).map(Number);
        if (categories.length === 0) return null;

        let closest = categories[0];
        let minDiff = Math.abs(targetCalories - closest);

        for (let i = 1; i < categories.length; i++) {
            const diff = Math.abs(targetCalories - categories[i]);
            if (diff < minDiff) {
                minDiff = diff;
                closest = categories[i];
            }
        }
        return closest;
    }
    
    function filterRecipes(mealType, category, profile) {
        const recipes = recipeDatabase[mealType][category];
        const dislikedIngredients = profile.dislikes.toLowerCase().split(',').map(item => item.trim()).filter(item => item !== 'none' && item !== '');
        const foodPref = profile.foodPref.toLowerCase();
        const healthIssues = profile.health.toLowerCase().split(',').map(item => item.trim()).filter(item => item !== 'none' && item !== '');

        return recipes.filter(recipe => {
            const recipeIngredients = recipe.ingredients.map(ing => ing.toLowerCase());
            
            if (dislikedIngredients.some(dislike => recipeIngredients.includes(dislike))) {
                return false;
            }

            if (healthIssues.includes('hypertension') && recipe.sodium > 500) {
              return false;
            }

            if (foodPref === 'vegetarian' && recipeIngredients.some(ing => ['chicken', 'beef', 'steak', 'salmon', 'pork', 'lamb', 'gelatin'].includes(ing))) {
                return false;
            }
            if (foodPref === 'vegan' && recipeIngredients.some(ing => ['eggs', 'milk', 'cheese', 'yogurt', 'chicken', 'beef', 'steak', 'salmon', 'pork', 'lamb', 'butter', 'honey', 'cream'].includes(ing))) {
                return false;
            }

            return true;
        });
    }

    // THIS IS THE CHANGE
    // Wrap the main function call in a DOMContentLoaded event listener
    document.addEventListener('DOMContentLoaded', function() {
      function generateMealPlan() {
        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
        if (!loggedInUser || !loggedInUser.profile || !loggedInUser.profile.gender) {
          document.getElementById("mealPlanContainer").innerHTML = `<p class="text-center text-red-500">Please complete your profile on the dashboard first.</p>`;
          document.getElementById("mealPlanSummary").innerHTML = "";
          return;
        }

        const dailyCaloriesTarget = calculateBMR(loggedInUser.profile);
        const dailyProteinTarget = calculateProteinTarget(loggedInUser.profile);
        
        const mealPlan = {
          Breakfast: Math.round(dailyCaloriesTarget * 0.25),
          Lunch: Math.round(dailyCaloriesTarget * 0.35),
          Dinner: Math.round(dailyCaloriesTarget * 0.35),
          Snack: Math.round(dailyCaloriesTarget * 0.05)
        };

        let totalGeneratedCalories = 0;
        let totalGeneratedProtein = 0;
        let htmlContent = '';
        let generatedRecipes = {};

        for (const meal in mealPlan) {
            const targetCalories = mealPlan[meal];
            const closestCategory = findClosestCalorieCategory(meal, targetCalories);
            
            if (closestCategory) {
                const availableRecipes = filterRecipes(meal, closestCategory, loggedInUser.profile);
                
                if (availableRecipes.length > 0) {
                    const randomRecipe = availableRecipes[Math.floor(Math.random() * availableRecipes.length)];
                    totalGeneratedCalories += randomRecipe.calories;
                    totalGeneratedProtein += randomRecipe.protein;
                    generatedRecipes[meal] = randomRecipe;
                } else {
                    htmlContent += `<p class="bg-white p-4 rounded-lg shadow">No recipes found for ${meal} based on your preferences. Try editing your profile to broaden your options.</p>`;
                }
            } else {
                htmlContent += `<p class="bg-white p-4 rounded-lg shadow">No recipes found for ${meal}.</p>`;
            }
        }

        for (const meal in generatedRecipes) {
            const recipe = generatedRecipes[meal];
            const closestCategory = findClosestCalorieCategory(meal, mealPlan[meal]);
            htmlContent += `
                <div class="bg-white p-6 rounded-lg shadow flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-6">
                    <div class="md:w-1/3">
                        <img src="${recipe.image}" alt="${recipe.name}" class="rounded-lg object-cover w-full h-40">
                    </div>
                    <div class="md:w-2/3">
                        <h4 class="text-xl font-bold">${meal}: ${recipe.name}</h4>
                        <p class="text-sm mt-2">Calories: ${recipe.calories} kcal</p>
                        <p class="text-sm">Protein: ${recipe.protein} g</p>
                        <p class="text-sm font-bold mt-2">Meal Target: ~${closestCategory} kcal</p>
                    </div>
                </div>
            `;
        }
        document.getElementById("mealPlanContainer").innerHTML = htmlContent;

        const calorieDifference = totalGeneratedCalories - Math.round(dailyCaloriesTarget);
        const proteinDifference = totalGeneratedProtein - dailyProteinTarget;
        
        const summaryHTML = `
          <h3 class="text-xl font-bold mb-2">Daily Nutrition Targets</h3>
          <p class="text-md">Calories: <strong>${Math.round(dailyCaloriesTarget)} kcal</strong> (Total from plan: ${totalGeneratedCalories} kcal)</p>
          <p class="text-sm text-gray-600">Difference: ${calorieDifference > 0 ? `+${calorieDifference}` : calorieDifference} kcal</p>
          <p class="text-md mt-2">Protein: <strong>${dailyProteinTarget} g</strong> (Total from plan: ${totalGeneratedProtein} g)</p>
          <p class="text-sm text-gray-600">Difference: ${proteinDifference > 0 ? `+${proteinDifference}` : proteinDifference} g</p>
        `;
        document.getElementById("mealPlanSummary").innerHTML = summaryHTML;
      }

      document.getElementById("generateBtn").addEventListener("click", generateMealPlan);

      generateMealPlan();
    });
    // END OF THE CHANGE

    document.getElementById("logoutBtn").addEventListener("click", function() {
      localStorage.removeItem("loggedInUser");
      window.location.href = "login.html";
    });
  </script>
</body>
</html>
